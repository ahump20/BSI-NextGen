<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sandlot Sluggers - Embedded Game</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      html,
      body {
        width: 100%;
        height: 100%;
        overflow: hidden;
        background: #000;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
      }

      #renderCanvas {
        width: 100%;
        height: 100%;
        display: block;
        touch-action: none;
      }

      .embed-info {
        position: absolute;
        top: 10px;
        left: 10px;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 8px 12px;
        border-radius: 4px;
        font-size: 12px;
        z-index: 1000;
        display: none;
      }

      .embed-info.visible {
        display: block;
      }

      /* Loading overlay */
      .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #000;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
      }

      .loading-overlay.hidden {
        display: none;
      }

      .loading-spinner {
        width: 50px;
        height: 50px;
        border: 4px solid rgba(255, 255, 255, 0.2);
        border-top-color: #fff;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <div class="loading-overlay" id="loadingOverlay">
      <div class="loading-spinner"></div>
    </div>

    <div class="embed-info" id="embedInfo">
      Embedded on: <span id="parentOrigin">Unknown</span>
    </div>

    <canvas id="renderCanvas"></canvas>

    <script type="module">
      /**
       * Sandlot Sluggers - Embeddable Version
       * For integration with Blaze Sports Intel platform
       */

      // Embedded game communication API
      class EmbedAPI {
        constructor() {
          this.parentOrigin = null;
          this.messageHandlers = new Map();
          this.setupMessageListener();
          this.detectParentOrigin();
        }

        setupMessageListener() {
          window.addEventListener("message", (event) => {
            // Security: Verify origin
            if (!this.isAllowedOrigin(event.origin)) {
              console.warn(`Rejected message from unauthorized origin: ${event.origin}`);
              return;
            }

            const { type, data } = event.data;

            if (this.messageHandlers.has(type)) {
              this.messageHandlers.get(type)(data);
            }
          });
        }

        isAllowedOrigin(origin) {
          const allowed = [
            "https://blazesportsintel.com",
            "https://www.blazesportsintel.com",
            "http://localhost:3000",
            "http://localhost:5173",
            "http://localhost:4173",
          ];

          return allowed.includes(origin) || origin === window.location.origin;
        }

        detectParentOrigin() {
          if (window.parent !== window) {
            // In iframe, get parent origin from referrer
            const referrer = document.referrer;
            if (referrer) {
              try {
                const url = new URL(referrer);
                this.parentOrigin = url.origin;
                document.getElementById("parentOrigin").textContent =
                  this.parentOrigin;
              } catch (e) {
                console.error("Failed to parse referrer:", e);
              }
            }
          }
        }

        on(messageType, handler) {
          this.messageHandlers.set(messageType, handler);
        }

        send(messageType, data) {
          if (window.parent !== window) {
            window.parent.postMessage(
              { type: messageType, data },
              this.parentOrigin || "*"
            );
          }
        }

        notifyReady() {
          this.send("gameReady", {
            version: "1.0.0",
            timestamp: new Date().toISOString(),
          });
        }

        notifyGameStart() {
          this.send("gameStart", {
            timestamp: new Date().toISOString(),
          });
        }

        notifyGameEnd(stats) {
          this.send("gameEnd", {
            stats,
            timestamp: new Date().toISOString(),
          });
        }

        notifyStatsUpdate(stats) {
          this.send("statsUpdate", {
            stats,
            timestamp: new Date().toISOString(),
          });
        }
      }

      // Initialize embed API
      const embedAPI = new EmbedAPI();

      // Listen for commands from parent
      embedAPI.on("startGame", (data) => {
        console.log("Parent requested game start:", data);
        // Trigger game start
      });

      embedAPI.on("resetGame", () => {
        console.log("Parent requested game reset");
        // Reset game state
        window.location.reload();
      });

      embedAPI.on("getStats", () => {
        // Send current stats to parent
        embedAPI.notifyStatsUpdate({
          // TODO: Get actual stats from game engine
          homeRuns: 0,
          strikeouts: 0,
          hits: 0,
        });
      });

      // Import and initialize game
      import("./src/main.ts")
        .then((module) => {
          // Hide loading overlay
          document.getElementById("loadingOverlay").classList.add("hidden");

          // Show embed info in dev mode
          if (import.meta.env.DEV) {
            document.getElementById("embedInfo").classList.add("visible");
          }

          // Notify parent that game is ready
          embedAPI.notifyReady();

          console.log("âœ… Sandlot Sluggers embedded game initialized");
        })
        .catch((error) => {
          console.error("Failed to load game:", error);
          document.getElementById("loadingOverlay").innerHTML = `
            <div style="color: white; text-align: center;">
              <h2>Failed to load game</h2>
              <p>${error.message}</p>
            </div>
          `;
        });

      // Export embed API for parent window access
      window.sandlotSluggers = {
        api: embedAPI,
        version: "1.0.0",
      };
    </script>
  </body>
</html>
