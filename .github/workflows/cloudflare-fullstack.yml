name: Cloudflare Full-Stack Delivery

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      promote_to_production:
        description: Promote latest staging artifact to production (requires approval)
        required: false
        type: boolean
        default: false
      rollback_production:
        description: Trigger rollback using the last successful staging artifact
        required: false
        type: boolean
        default: false

env:
  NODE_VERSION: '18'
  PNPM_VERSION: '8'
  NEXT_TELEMETRY_DISABLED: '1'
  CI: true

jobs:
  validate-packages:
    name: Build and test ${{ matrix.component }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        component: [web, api]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build ${{ matrix.component }}
        run: pnpm --filter @bsi/${{ matrix.component }} build

      - name: Test ${{ matrix.component }}
        run: pnpm --filter @bsi/${{ matrix.component }} test -- --runInBand

  smoke-and-lighthouse:
    name: Smoke + Lighthouse budgets
    runs-on: ubuntu-latest
    needs: validate-packages
    if: github.event_name != 'workflow_dispatch'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build Next.js for smoke tests
        run: pnpm --filter @bsi/web build

      - name: Start Next.js server
        run: |
          pnpm --filter @bsi/web start -- -H 0.0.0.0 -p 3000 &
          echo $! > /tmp/next_pid
          for i in {1..20}; do
            if curl -sSf http://localhost:3000 >/dev/null; then
              exit 0
            fi
            sleep 3
          done
          echo "Next.js failed to start" && exit 1

      - name: Smoke check homepage and API
        run: |
          curl -I http://localhost:3000
          curl -I http://localhost:3000/api/health || echo "API health endpoint not yet exposed"

      - name: Lighthouse performance & accessibility budgets
        run: |
          mkdir -p artifacts
          npx lighthouse http://localhost:3000 \
            --only-categories=performance,accessibility,best-practices \
            --budget-path=.github/lighthouse-budgets.json \
            --quiet \
            --output=json \
            --output-path=artifacts/lighthouse-report.json \
            --chrome-flags="--headless --no-sandbox"

      - name: Upload Lighthouse report
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-report
          path: artifacts/lighthouse-report.json

      - name: Stop Next.js
        if: always()
        run: |
          if [ -f /tmp/next_pid ]; then
            kill $(cat /tmp/next_pid) || true
          fi

  deploy-staging:
    name: Deploy to Cloudflare staging
    needs: [validate-packages, smoke-and-lighthouse]
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment:
      name: staging
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build API + Web for staging
        run: |
          pnpm --filter @bsi/api build
          pnpm --filter @bsi/web build

      - name: Export Next.js for Cloudflare Pages
        working-directory: packages/web
        run: pnpm exec npx @cloudflare/next-on-pages --outdir .vercel/output/static --experimental-minify

      - name: Deploy Workers (KV/D1/R2 bindings)
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: cloudflare-workers/blaze-trends
          command: deploy --env development

      - name: Deploy Next.js to Cloudflare Pages (staging)
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: ${{ secrets.CLOUDFLARE_PAGES_PROJECT }}
          directory: packages/web/.vercel/output/static
          branch: staging
        env:
          NODE_VERSION: ${{ env.NODE_VERSION }}
          NEXT_TELEMETRY_DISABLED: '1'

      - name: Netlify fallback deploy (optional)
        run: |
          if [ -n "${NETLIFY_AUTH_TOKEN}" ] && [ -n "${NETLIFY_SITE_ID}" ]; then
            npx netlify deploy --dir=packages/web/.vercel/output/static --site="${NETLIFY_SITE_ID}" --auth="${NETLIFY_AUTH_TOKEN}" --alias=staging-fallback
          else
            echo "Skipping Netlify fallback deploy: NETLIFY_AUTH_TOKEN or NETLIFY_SITE_ID not set."
          fi
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
      - name: Package staging artifact for promotion
        run: |
          tar -czf staging-artifact.tar.gz packages/web/.vercel/output/static cloudflare-workers

      - name: Upload staged artifact
        uses: actions/upload-artifact@v4
        with:
          name: staging-release
          path: staging-artifact.tar.gz

  promote-production:
    name: Promote to production
    needs: deploy-staging
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.promote_to_production == 'true'
    runs-on: ubuntu-latest
    environment:
      name: production
    steps:
      - name: Download staged artifact
        uses: actions/download-artifact@v4
        with:
          name: staging-release
          path: ./release

      - name: Extract release bundle
        run: tar -xzf release/staging-artifact.tar.gz

      - name: Deploy Workers (production)
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: cloudflare-workers/blaze-trends
          command: deploy --env production

      - name: Deploy Next.js to Cloudflare Pages (production)
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: ${{ secrets.CLOUDFLARE_PAGES_PROJECT }}
          directory: packages/web/.vercel/output/static
          branch: production
        env:
          NODE_VERSION: ${{ env.NODE_VERSION }}
          NEXT_TELEMETRY_DISABLED: '1'

      - name: Netlify production fallback (optional)
        run: |
          if [ -n "${NETLIFY_AUTH_TOKEN}" ] && [ -n "${NETLIFY_SITE_ID}" ]; then
            npx netlify deploy --dir=packages/web/.vercel/output/static --site="${NETLIFY_SITE_ID}" --auth="${NETLIFY_AUTH_TOKEN}" --prod
          else
            echo "Skipping Netlify production fallback deploy: NETLIFY_AUTH_TOKEN or NETLIFY_SITE_ID not set."
          fi
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}

  rollback-production:
    name: Rollback production from staged artifact
    # Removed needs: deploy-staging
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.rollback_production == 'true'
    runs-on: ubuntu-latest
    environment:
      name: production
    steps:
      - name: Find latest successful deploy-staging run
        id: find_run
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const runs = await github.rest.actions.listWorkflowRunsForRepo({
              owner,
              repo,
              branch: 'main',
              status: 'success',
              event: 'push',
              per_page: 10
            });
            const run = runs.data.workflow_runs.find(r => r.name === 'Cloudflare Full-Stack Delivery');
            if (!run) throw new Error('No successful deploy-staging run found');
            return run.id;
      - name: Download staged artifact from previous run
        uses: actions/download-artifact@v4
        with:
          name: staging-release
          path: ./release
          run-id: ${{ steps.find_run.outputs.result }}

      - name: Extract release bundle
        run: tar -xzf release/staging-artifact.tar.gz

      - name: Rollback Workers to last staged build
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: cloudflare-workers/blaze-trends
          command: deploy --env production --minify

      - name: Rollback Cloudflare Pages to staged artifact
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: ${{ secrets.CLOUDFLARE_PAGES_PROJECT }}
          directory: packages/web/.vercel/output/static
          branch: production
        env:
          NODE_VERSION: ${{ env.NODE_VERSION }}
          NEXT_TELEMETRY_DISABLED: '1'
